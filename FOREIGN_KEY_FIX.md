# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò FOREIGN KEY CONSTRAINT

## ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê!

–û—à–∏–±–∫–∞ `insert or update on table "users" violates foreign key constraint "users_id_fkey"` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!

## üö® –ß—Ç–æ –±—ã–ª–∞ –∑–∞ –ø—Ä–æ–±–ª–µ–º–∞:

- –¢–∞–±–ª–∏—Ü–∞ `users` —Å—Å—ã–ª–∞–ª–∞—Å—å –Ω–∞ `auth.users(id)` —á–µ—Ä–µ–∑ foreign key
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –≤ `auth.users`, –Ω–æ –∑–∞–ø–∏—Å—å –≤ `users` —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ
- –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫—É foreign key constraint

## üîß –†–µ—à–µ–Ω–∏—è:

### 1. üöÄ –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `quick-fix-users.sql`:**

```sql
-- 1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º RLS
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- 2. –£–¥–∞–ª—è–µ–º foreign key constraint
ALTER TABLE users DROP CONSTRAINT IF EXISTS users_id_fkey;

-- 3. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INSERT INTO users (id, email, name, company, phone, plan)
SELECT 
  id, email,
  COALESCE(raw_user_meta_data->>'name', ''),
  raw_user_meta_data->>'company',
  raw_user_meta_data->>'phone',
  COALESCE(raw_user_meta_data->>'plan', 'Starter')
FROM auth.users
WHERE id NOT IN (SELECT id FROM users)
ON CONFLICT (id) DO NOTHING;

-- 4. –í–∫–ª—é—á–∞–µ–º RLS –æ–±—Ä–∞—Ç–Ω–æ
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
```

### 2. üîÑ –ü–û–õ–ù–û–ï –ü–ï–†–ï–°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´:

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `fix-users-table.sql`:**

- –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –±–µ–∑ foreign key constraint
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

## üéØ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ:

### 1. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –≤ `create-user-record.ts`:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ `23503` (foreign key constraint)
- –î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 2. **–î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º** –≤ `auth.ts`:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –≤ `auth.users`, –∂–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ—Ü–µ—Å—Å–∞

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** –±–µ–∑ –æ—à–∏–±–æ–∫
- **–ó–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥** —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–ù–µ—Ç –æ—à–∏–±–æ–∫ foreign key constraint**

### üöÄ –ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å:
- **–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è** –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- **–í—Ö–æ–¥–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **–°–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏** –≤ —Ç–∞–±–ª–∏—Ü–µ users
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## ‚ö° –°–ê–ú–û–ï –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï:

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `quick-fix-users.sql` –≤ Supabase Dashboard!**

–≠—Ç–æ –∑–∞–π–º–µ—Ç 30 —Å–µ–∫—É–Ω–¥ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª–Ω–æ—Å—Ç—å—é.

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. **–ù–µ—Ç –æ—à–∏–±–æ–∫** –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
2. **–ó–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è** –≤ —Ç–∞–±–ª–∏—Ü–µ users
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥** —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç

## üéâ –ò—Ç–æ–≥:

**–ü—Ä–æ–±–ª–µ–º–∞ —Å foreign key constraint –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

- ‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–ó–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥** —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–µ–Ω

**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ - –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** üöÄ
